<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Issues JSON API</title>
</head>
<body>
  <script>
    // ä» localStorage æˆ– postMessage è·å– issues æ•°æ®
    function getIssuesData() {
      return new Promise((resolve) => {
        // ä¼˜å…ˆä» localStorage è·å–
        const storedData = localStorage.getItem('gwitter_issues_data');
        if (storedData) {
          try {
            resolve(JSON.parse(storedData));
            return;
          } catch (e) {
            console.error('Failed to parse stored data:', e);
          }
        }

        // å°è¯•ä»çˆ¶çª—å£è·å–
        if (window.opener && window.opener.gwitterIssuesData) {
          resolve(window.opener.gwitterIssuesData);
          return;
        }

        // å¦‚æœéƒ½æ²¡æœ‰ï¼Œè¿”å› null
        resolve(null);
      });
    }

    // ä¸»é€»è¾‘
    (async function() {
      const urlParams = new URLSearchParams(window.location.search);
      const format = urlParams.get('format');

      // å¦‚æœè¯·æ±‚ JSON æ ¼å¼
      if (format === 'json' || window.location.pathname.endsWith('.json')) {
        const data = await getIssuesData();
        
        if (data && data.issues && data.issues.length > 0) {
          // è¾“å‡º JSON
          document.body.style.display = 'none';
          
          // åˆ›å»º pre æ ‡ç­¾æ˜¾ç¤º JSON
          const pre = document.createElement('pre');
          pre.style.cssText = 'display:block;margin:0;padding:20px;font-family:monospace;font-size:14px;line-height:1.5;color:#333;word-wrap:break-word;white-space:pre-wrap;';
          pre.textContent = JSON.stringify(data, null, 2);
          document.body.appendChild(pre);
          pre.style.display = 'block';
          
          // è®¾ç½® document title ä»¥ä¾¿è¯†åˆ«
          document.title = `Gwitter Issues - ${data.repository}`;
          
          // å°è¯•è®¾ç½® Content-Typeï¼ˆåœ¨é™æ€ç¯å¢ƒä¸­å¯èƒ½ä¸ç”Ÿæ•ˆï¼‰
          const meta = document.createElement('meta');
          meta.setAttribute('http-equiv', 'Content-Type');
          meta.setAttribute('content', 'application/json');
          document.head.appendChild(meta);
        } else {
          // æ— æ•°æ®æ—¶æ˜¾ç¤ºæç¤º
          document.body.innerHTML = `
            <div style="display:flex;align-items:center;justify-content:center;min-height:100vh;font-family:Arial,sans-serif;background:#f5f5f5;">
              <div style="text-align:center;padding:40px;">
                <h1 style="color:#333;margin-bottom:20px;">No Data Available</h1>
                <p style="color:#666;line-height:1.6;">
                  Please follow these steps to get Issues data:
                </p>
                <div style="background:#fff;padding:20px;border-radius:8px;margin:20px 0;box-shadow:0 2px 8px rgba(0,0,0,0.1);">
                  <ol style="text-align:left;line-height:1.8;color:#555;">
                    <li>Open the main Gwitter page</li>
                    <li>Wait for issues to load</li>
                    <li>Then access this API endpoint</li>
                    <li>Or click the "JSON" button in the toolbar</li>
                  </ol>
                </div>
                <a href="/" style="display:inline-block;margin-top:20px;padding:10px 20px;background:#8f63e9;color:#fff;text-decoration:none;border-radius:5px;">Go to Gwitter Home</a>
              </div>
            </div>
          `;
        }
      } else {
        // æ˜¾ç¤ºä½¿ç”¨è¯´æ˜
        document.body.innerHTML = `
          <div style="max-width:900px;margin:40px auto;padding:20px;font-family:Arial,sans-serif;">
            <h1 style="color:#333;border-bottom:3px solid #8f63e9;padding-bottom:15px;margin-bottom:20px;">Gwitter Issues JSON API</h1>
            
            <div style="background:#e8f5e9;color:#fff;padding:15px;border-radius:5px;margin:20px 0;">
              <strong>ğŸ“Œ Quick Start:</strong>
              <p style="margin:10px 0;">è®¿é—®æ­¤ API æ¥å£è·å– Issues æ•°æ®ï¼š</p>
            </div>
            
            <div style="margin:30px 0;">
              <h3 style="color:#8f63e9;">API Endpoint:</h3>
              <div style="background:#f5f5f5;padding:15px;border-radius:5px;margin:10px 0;">
                <code style="background:#e96384;color:#fff;padding:5px 12px;border-radius:3px;display:block;font-size:14px;">
                  ${window.location.origin}/issues.json?format=json
                </code>
              </div>
              
              <h3 style="color:#8f63e9;margin-top:30px;">Response Format:</h3>
              <pre style="background:#282c34;color:#abb2bf;padding:15px;border-radius:5px;overflow-x:auto;font-size:13px;line-height:1.6;">{
  "repository": "owner/repo",
  "exportedAt": "2024-01-01T00:00:00.000Z",
  "totalIssues": 10,
  "issues": [
    {
      "id": "issue_id",
      "number": 1,
      "title": "Issue æ ‡é¢˜",
      "createdAt": "2024-01-01T00:00:00.000Z",
      "author": {
        "login": "username",
        "avatarUrl": "https://...",
        "url": "https://..."
      },
      "reactions": {
        "totalCount": 5,
        "userReacted": true,
        "heartCount": 5
      },
      "comments": 3,
      "label": {
        "name": "label_name",
        "color": "#ffffff"
      },
      "url": "https://github.com/..."
    }
  ]
}</pre>
              
              <h3 style="color:#8f63e9;margin-top:30px;">Usage Examples:</h3>
              
              <div style="background:#f5f5f5;padding:20px;border-radius:5px;margin:10px 0;">
                <h4 style="color:#333;margin-top:0;">JavaScript (Fetch API):</h4>
                <pre style="background:#282c34;color:#abb2bf;padding:15px;border-radius:5px;overflow-x:auto;font-size:13px;line-height:1.6;">fetch('${window.location.origin}/issues.json?format=json')
  .then(response => response.text())
  .then(jsonText => {
    const data = JSON.parse(jsonText);
    console.log('Issues:', data);
    
    // å¤„ç†æ•°æ®
    data.issues.forEach(issue => {
      console.log(issue.title, issue.author.login);
    });
  });</pre>
              </div>
              
              <div style="background:#f5f5f5;padding:20px;border-radius:5px;margin:10px 0;">
                <h4 style="color:#333;margin-top:0;">JavaScript (async/await):</h4>
                <pre style="background:#282c34;color:#abb2bf;padding:15px;border-radius:5px;overflow-x:auto;font-size:13px;line-height:1.6;">async function fetchIssues() {
  const response = await fetch('${window.location.origin}/issues.json?format=json');
  const jsonText = await response.text();
  const data = JSON.parse(jsonText);
  
  console.log('Repository:', data.repository);
  console.log('Total Issues:', data.totalIssues);
  console.log('Issues:', data.issues);
  
  return data;
}

// ä½¿ç”¨
fetchIssues().then(data => {
  // å¤„ç† issues æ•°æ®
});</pre>
              </div>

              <div style="background:#f5f5f5;padding:20px;border-radius:5px;margin:10px 0;">
                <h4 style="color:#333;margin-top:0;">TypeScript:</h4>
                <pre style="background:#282c34;color:#abb2bf;padding:15px;border-radius:5px;overflow-x:auto;font-size:13px;line-height:1.6;">interface GwitterIssue {
  id: string;
  number: number;
  title: string;
  createdAt: string;
  author: {
    login: string;
    avatarUrl: string;
    url: string;
  };
  reactions: {
    totalCount: number;
    userReacted: boolean;
    heartCount: number;
  };
  comments: number;
  label: {
    name: string;
    color: string;
  };
  url: string;
}

interface GwitterResponse {
  repository: string;
  exportedAt: string;
  totalIssues: number;
  issues: GwitterIssue[];
}

async function getGwitterIssues(): Promise<GwitterResponse> {
  const response = await fetch('${window.location.origin}/issues.json?format=json');
  const jsonText = await response.text();
  return JSON.parse(jsonText) as GwitterResponse;
}

// ä½¿ç”¨
const data = await getGwitterIssues();
console.log(\`Loaded \${data.totalIssues} issues from \${data.repository}\`);</pre>
              </div>

              <div style="background:#fff9c6;padding:15px;border-radius:5px;margin:10px 0;border-left:4px solid #ffc107;">
                <h4 style="color:#333;margin-top:0;">âš ï¸ CORS æ³¨æ„äº‹é¡¹:</h4>
                <ul style="line-height:1.8;color:#555;">
                  <li>å¦‚æœé‡åˆ°è·¨åŸŸé—®é¢˜ï¼Œè¯·ç¡®ä¿ä¸¤ä¸ªé¡¹ç›®åœ¨åŒä¸€ä¸ªåŸŸåä¸‹</li>
                  <li>æˆ–é…ç½®æœåŠ¡å™¨æ·»åŠ  CORS å¤´</li>
                  <li>æˆ–ä½¿ç”¨ä»£ç†æœåŠ¡å™¨ä¸­è½¬è¯·æ±‚</li>
                </ul>
              </div>
            </div>
            
            <h3 style="color:#8f63e9;margin-top:40px;">Field Descriptions:</h3>
            <div style="background:#f5f5f5;padding:20px;border-radius:5px;margin:20px 0;">
              <table style="width:100%;border-collapse:collapse;">
                <tr style="background:#fff;color:#333;">
                  <th style="padding:12px;text-align:left;border-bottom:2px solid #ddd;">å­—æ®µ</th>
                  <th style="padding:12px;text-align:left;border-bottom:2px solid #ddd;">ç±»å‹</th>
                  <th style="padding:12px;text-align:left;border-bottom:2px solid #ddd;">è¯´æ˜</th>
                </tr>
                <tr style="background:#f9f9f9;">
                  <td style="padding:12px;border-bottom:1px solid #eee;"><code>repository</code></td>
                  <td style="padding:12px;border-bottom:1px solid #eee;">string</td>
                  <td style="padding:12px;border-bottom:1px solid #eee;">ä»“åº“åœ°å€ï¼ˆowner/repoï¼‰</td>
                </tr>
                <tr style="background:#fff;">
                  <td style="padding:12px;border-bottom:1px solid #eee;"><code>exportedAt</code></td>
                  <td style="padding:12px;border-bottom:1px solid #eee;">string (ISO 8601)</td>
                  <td style="padding:12px;border-bottom:1px solid #eee;">å¯¼å‡ºæ—¶é—´ï¼ˆISO æ ¼å¼ï¼‰</td>
                </tr>
                <tr style="background:#f9f9f9;">
                  <td style="padding:12px;border-bottom:1px solid #eee;"><code>totalIssues</code></td>
                  <td style="padding:12px;border-bottom:1px solid #eee;">number</td>
                  <td style="padding:12px;border-bottom:1px solid #eee;">Issues æ€»æ•°</td>
                </tr>
                <tr style="background:#fff;">
                  <td style="padding:12px;border-bottom:1px solid #eee;"><code>issues[].id</code></td>
                  <td style="padding:12px;border-bottom:1px solid #eee;">string</td>
                  <td style="padding:12px;border-bottom:1px solid #eee;">Issue å”¯ä¸€æ ‡è¯†ç¬¦</td>
                </tr>
                <tr style="background:#f9f9f9;">
                  <td style="padding:12px;border-bottom:1px solid #eee;"><code>issues[].number</code></td>
                  <td style="padding:12px;border-bottom:1px solid #eee;">number</td>
                  <td style="padding:12px;border-bottom:1px solid #eee;">Issue ç¼–å·</td>
                </tr>
                <tr style="background:#fff;">
                  <td style="padding:12px;border-bottom:1px solid #eee;"><code>issues[].title</code></td>
                  <td style="padding:12px;border-bottom:1px solid #eee;">string</td>
                  <td style="padding:12px;border-bottom:1px solid #eee;">Issue æ ‡é¢˜</td>
                </tr>
                <tr style="background:#f9f9f9;">
                  <td style="padding:12px;border-bottom:1px solid #eee;"><code>issues[].author</code></td>
                  <td style="padding:12px;border-bottom:1px solid #eee;">object</td>
                  <td style="padding:12px;border-bottom:1px solid #eee;">ä½œè€…ä¿¡æ¯ï¼ˆåŒ…å« login, avatarUrl, urlï¼‰</td>
                </tr>
                <tr style="background:#fff;">
                  <td style="padding:12px;border-bottom:1px solid #eee;"><code>issues[].reactions</code></td>
                  <td style="padding:12px;border-bottom:1px solid #eee;">object</td>
                  <td style="padding:12px;border-bottom:1px solid #eee;">ååº”ç»Ÿè®¡ï¼ˆtotalCount, userReacted, heartCountï¼‰</td>
                </tr>
                <tr style="background:#f9f9f9;">
                  <td style="padding:12px;border-bottom:1px solid #eee;"><code>issues[].comments</code></td>
                  <td style="padding:12px;border-bottom:1px solid #eee;">number</td>
                  <td style="padding:12px;border-bottom:1px solid #eee;">è¯„è®ºæ•°é‡</td>
                </tr>
                <tr style="background:#fff;">
                  <td style="padding:12px;border-bottom:1px solid #eee;"><code>issues[].label</code></td>
                  <td style="padding:12px;border-bottom:1px solid #eee;">object</td>
                  <td style="padding:12px;border-bottom:1px solid #eee;">æ ‡ç­¾ä¿¡æ¯ï¼ˆname, colorï¼‰</td>
                </tr>
                <tr style="background:#f9f9f9;">
                  <td style="padding:12px;border-bottom:1px solid #eee;"><code>issues[].url</code></td>
                  <td style="padding:12px;border-bottom:1px solid #eee;">string</td>
                  <td style="padding:12px;border-bottom:1px solid #eee;">Issue åœ¨ GitHub çš„é“¾æ¥</td>
                </tr>
              </table>
            </div>
            
            <div style="margin-top:40px;padding:20px;background:#e8f5e9;color:#fff;border-radius:5px;">
              <strong>ğŸ’¡ æç¤ºï¼š</strong>
              <ul style="line-height:1.8;margin-top:10px;">
                <li>é¦–æ¬¡ä½¿ç”¨å‰ï¼Œè¯·å…ˆæ‰“å¼€ Gwitter ä¸»é¡µåŠ è½½ Issues æ•°æ®</li>
                <li>ç‚¹å‡»å·¥å…·æ çš„ "JSON" æŒ‰é’®æ‰‹åŠ¨è§¦å‘æ•°æ®æ›´æ–°</li>
                <li>æ•°æ®ä¼šè‡ªåŠ¨ä¿å­˜åˆ°æµè§ˆå™¨ localStorage</li>
                <li>ä¸‹æ¬¡è®¿é—® API æ¥å£æ—¶ä¼šç›´æ¥è¿”å›æœ€æ–°çš„æ•°æ®</li>
              </ul>
            </div>
            
            <div style="text-align:center;margin-top:40px;padding:20px;border-top:2px solid #e0e0e0;">
              <a href="/" style="display:inline-block;padding:10px 30px;background:#8f63e9;color:#fff;text-decoration:none;border-radius:5px;font-size:16px;">â† è¿”å› Gwitter</a>
            </div>
          </div>
        `;
      }
    })();
  </script>
</body>
</html>
